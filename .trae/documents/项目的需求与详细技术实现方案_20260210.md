# 项目的需求与详细技术实现方案

## 快速概览
- 项目名称：QuarkPanTool
- 目标：提供批量转存、批量分享、批量下载及“一键下载”自动化，减少人工操作并提升下载体验
- 技术栈：Python 3.11、httpx、playwright、tqdm、prettytable
- 代码入口：[quark.py](file:///e:/_python_work/QuarkPanTool/quark.py)

## 快速开始
- 启动交互菜单：`python quark.py`
- 一键下载（含提取码）：`python quark.py --download "https://pan.quark.cn/s/abcd?pwd=123456"`
- 指定临时 Cookie 并下载：`python quark.py --cookie "<Cookie字符串>" --download "https://pan.quark.cn/s/abcd?pwd=123456"`
- 批量操作：将分享地址写入 `config/url.txt`，选择菜单 1/2

## 功能清单
- 账户登录与 Cookie 管理
- 分享链接解析（支持 `?pwd=xxxxxx`）
- 转存到指定或临时目录
- 批量生成分享链接（仅文件夹）
- 批量下载（支持单文件与分片多线程）
- 一键下载自动化（菜单 7 与 `--download`）
- 保存目录切换与目录创建
- 交互式菜单与 CLI 参数

## 架构与模块
- [quark_login.py](file:///e:/_python_work/QuarkPanTool/quark_login.py)
  - 登录与 Cookie 获取/转换/校验
  - 方法：`save_cookies(page)`、`check_cookies()`、`transfer_cookies()`、`dict_to_cookie_str()`、`get_cookies()`
- [utils.py](file:///e:/_python_work/QuarkPanTool/utils.py)
  - 基础读写：`save_config(path, content, mode='w')`、`read_config(path, read_type=None, mode='r')`
- [quark.py](file:///e:/_python_work/QuarkPanTool/quark.py)
  - `QuarkPanFileManager`：Cookie 加载与请求头构建；下载器（单线程与分片多线程）；流程编排：转存/分享/下载/目录管理/一键下载
  - 主程序：交互式菜单与 CLI 参数解析（支持 `--download`、`--cookie`）

## 配置与目录结构
- `config/config.json`：用户配置（`user`、`pdir_id`、`dir_name`、下载并发参数等）
- `config/cookies.txt`：Cookie 存储（字符串或浏览器 cookies 列表）
- `config/url.txt`：批量分享地址清单（一行一个）
- `output/share_url.txt`：批量分享生成的链接列表
- `output/downloads/`：批量下载保存目录
- 临时目录名：`_Download_<随机码>`（避免违规标记与冲突）
- 项目内路径均为相对项目根目录的相对路径

## 交互与 CLI
- 菜单（[quark.py:L1554-L1563](file:///e:/_python_work/QuarkPanTool/quark.py#L1554-L1563)）
  - 1：分享地址转存文件（支持单个/批量）
  - 2：批量生成分享链接（仅文件夹）
  - 3：切换网盘保存目录（根目录一级）
  - 4：创建网盘文件夹（根目录一级）
  - 5：下载到本地（自有网盘文件）
  - 6：登录（重置 cookies 并重新获取）
  - 7：一键下载他人分享链接（功能 1+2+5 的自动化组合）
- CLI 参数（[quark.py:L1609-L1620](file:///e:/_python_work/QuarkPanTool/quark.py#L1609-L1620)）
  - `--download "<分享链接>"`：自动化模式，执行“一键下载”
  - `--cookie "<Cookie字符串>"`：写入 `config/cookies.txt` 并优先使用该 Cookie
  - 已移除：`--save`

## Cookie 与登录
- 初始化：`QuarkPanFileManager.__init__` 调用 `get_cookies()` 从 `cookies.txt` 或登录流程获取；在请求头设置 `"cookie": self.cookies"`
- 验证（[get_user_info](file:///e:/_python_work/QuarkPanTool/quark.py#L172-L209)）：以文件列表 API 为主校验，`code == 0` 则有效；尝试获取昵称 `https://pan.quark.cn/account/info`（失败不影响）
- 覆盖：CLI 传入 `--cookie` 时先写入 `config/cookies.txt`，再初始化对象以确保后续请求使用新 Cookie

## 分享链接解析
- 格式：`https://pan.quark.cn/s/<id>`；带提取码：`https://pan.quark.cn/s/<id>?pwd=<提取码>`
- 示例：`https://pan.quark.cn/s/abcd?pwd=123456`
- 提取 `pwd_id`（[get_pwd_id](file:///e:/_python_work/QuarkPanTool/quark.py#L50-L57)）：`share_url.split("?")[0].split("/s/")[-1]`
- 提取 `pwd`：`re.search("pwd=(.*?)(?=$|&)", share_url)`

## 核心流程
- 转存（菜单 1 / 流水线步骤 1）
  - 输入单个 URL 或从 `config/url.txt` 批量读取
  - 调用 `run(url, to_dir_id, download=False)` 将分享内容转存到网盘目录
- 批量分享（菜单 2 / 流水线步骤 2）
  - 仅对文件夹生效
  - 生成的分享链接写入 `output/share_url.txt`
  - 可设定过期时间、是否加密、遍历深度等（交互输入）
- 下载到本地（菜单 5 / 流水线步骤 3）
  - 输入分享链接（需去除中文）或从 `output/share_url.txt` 批量读取
  - 保存到 `output/downloads`
- 下载实现（[download_file](file:///e:/_python_work/QuarkPanTool/quark.py#L517-L652)）
  - 小文件：单线程流式下载
  - 大文件：分片多线程，写入占位文件后并发覆盖（分片大小约为 `file_size // thread_count`）
  - 进度条：tqdm；多文件并行受 `concurrent_files` 信号量限制
- 数据面 API（[quark_file_download](file:///e:/_python_work/QuarkPanTool/quark.py#L654-L781)）
  - POST `https://drive-pc.quark.cn/1/clouddrive/file/download`
  - 如遇 `code == 23018`，调整 UA 为客户端 UA 后重试

## 一键下载（自动化）
- 入口（[main 自动化模式](file:///e:/_python_work/QuarkPanTool/quark.py#L1618-L1637)）：解析 `--download` 后清理 share 目录、准备用户信息、加载配置并调用 `one_click_download_pipeline(url)`
- 流水线（[one_click_download_pipeline](file:///e:/_python_work/QuarkPanTool/quark.py#L830-L975)）
  - 步骤 0：创建临时目录 `_Download_<随机码>`（不更新全局配置）
  - 步骤 1：转存分享链接内容至临时目录
  - 步骤 2：对临时目录批量生成分享链接，并进行失败重试
  - 步骤 3：读取 `output/share_url.txt`，逐条执行下载到本地
  - 清理：取消创建的分享链接，删除临时目录，捕获并报告清理错误
  - 特例：若检测到分享链接由当前用户创建，跳过转存/分享，直接下载
- 默认值：遍历深度 1；分享有效期 1 天（`expired_type=2`）；分享密码无；`url_type=1`

## 保存目录管理
- 加载与展示（[load_folder_id](file:///e:/_python_work/QuarkPanTool/quark.py#L1038-L1094)）：打印当前用户与当前保存目录
- 交互切换：输入 `0` 为根目录；按回车显示列表，输入序号选定一级目录
- 目录创建（菜单 4）：仅支持根目录下创建一级目录；流水线内可使用 `create_dir(name, update_config=False)` 创建临时目录

## 错误处理与退出码
- Cookie 无效：退出码 101
- 临时目录创建失败：退出码 102
- 转存失败：退出码 103
- 分享创建失败：退出码 104
- 下载链接为空或文件不存在：退出码 105
- 下载中出现错误：退出码 106
- 清理环节失败：退出码 107

## 性能与并发
- 多文件并行：`concurrent_files`（默认 3），通过信号量控制
- 单文件分片下载：`thread_count`（默认 5）
- 进度条刷新：`mininterval` 控制频率，避免终端闪烁

## 安全与合规
- 不记录或暴露隐私数据（如密码、令牌、完整 Cookie）到日志
- 临时目录命名随机化，减少违规标记
- 结束后取消分享、删除临时目录，避免遗留数据

## 使用示例
- 交互菜单：`python quark.py`
- 一键下载：`python quark.py --download "https://pan.quark.cn/s/abcd?pwd=123456"`
- 指定 Cookie：`python quark.py --cookie "<Cookie字符串>" --download "https://pan.quark.cn/s/abcd?pwd=123456"`

## 未来扩展建议
- 加强重试与断点续传（记录已完成分片）
- 下载限速与连接池优化
- 更灵活的目录遍历与层级分享
- 更丰富的日志与可观测性（下载失败原因、时间统计）
